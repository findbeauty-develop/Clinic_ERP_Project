datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// 공급업체 (Supplier) - Supplier company information
model Supplier {
  id                String    @id @default(uuid())
  tenant_id         String?   @unique // Unique - used as foreign key by SupplierManager
  company_name      String
  business_number   String    @unique // 사업자 등록번호
  company_phone     String?
  company_email     String
  company_address   String?
  product_categories String[]  @default([]) // 취급 제품 카테고리
  share_consent     Boolean   @default(false) // 회사 정보 공유 동의
  status            String    @default("pending") // pending, approved, rejected
  created_at        DateTime  @default(now())
  updated_at        DateTime?
  
  // Relations
  clinicManagers        ClinicSupplierManager[]
  managers              SupplierManager[]
  
  @@index([tenant_id])
  @@index([business_number])
  @@index([status])
}

// Clinic tomonidan yaratilgan Supplier Manager (Clinic context'da)
model ClinicSupplierManager {
  id                    String    @id @default(uuid())
  supplier_id           String
  tenant_id             String    // Qaysi clinic yaratgan
  name                  String
  phone_number          String    // NOT UNIQUE - faqat clinic context'da
  email1               String?
  email2               String?
  position              String?   // 직함
  certificate_image_url String?   // 사업자등록증 이미지 URL
  responsible_regions   String[]  @default([])
  responsible_products  String[]  @default([])
  memo                  String?
  created_at            DateTime  @default(now())
  updated_at            DateTime?
  
  // Relations
  supplier              Supplier  @relation(fields: [supplier_id], references: [id], onDelete: Cascade)
  linkedManager         SupplierManager? // Supplier ro'yxatdan o'tganda link qilinadi
  
  @@index([supplier_id])
  @@index([tenant_id])
  @@index([phone_number])
  @@index([tenant_id, phone_number]) // Composite index for clinic-specific search
}

// Supplier tomonidan yaratilgan Manager (Global, login uchun)
model SupplierManager {
  id                    String    @id @default(uuid())
  supplier_tenant_id    String    // Supplier'ning tenant_id'si (supplier_id o'rniga)
  clinic_manager_id     String?   @unique // ClinicSupplierManager bilan link (agar clinic yaratgan bo'lsa) - UNIQUE for one-to-one
  manager_id            String    @unique // 담당자 ID (회사이름+4자리 숫자)
  name                  String
  phone_number          String    @unique // UNIQUE - global
  certificate_image_url String?   // 사업자등록증 이미지 URL
  
  // 계정 정보 (required for login)
  password_hash         String?   // Optional - supplier ro'yxatdan o'tganda to'ldiriladi
  email1               String?   // Optional - supplier ro'yxatdan o'tganda to'ldiriladi
  
  // 담당 정보
  manager_address       String?   // 담당자 주소 (responsible_regions o'rniga)
  responsible_products  String[]  @default([]) // 담당 제품
  position              String?   // 직함 (Job Title): 사원, 주임, 대리, 과장, 차장, 부장
  
  status                String    @default("pending") // pending, approved, rejected, active
  created_at            DateTime  @default(now())
  updated_at            DateTime?
  created_by            String?   // Who created this manager (clinic or self-registered)
  
  // Relations
  supplier              Supplier  @relation(fields: [supplier_tenant_id], references: [tenant_id], onDelete: Cascade)
  clinicManager         ClinicSupplierManager? @relation(fields: [clinic_manager_id], references: [id], onDelete: SetNull)
  
  @@index([supplier_tenant_id])
  @@index([manager_id])
  @@index([phone_number])
  @@index([email1])
  @@index([status])
  @@index([clinic_manager_id])
  @@index([created_by])
}

// 공급업체 지역 태그 (Supplier Region Tag) - For search/matching
model SupplierRegionTag {
  id        String   @id @default(uuid())
  name      String   @unique
  created_at DateTime @default(now())
  
  @@index([name])
}

// 공급업체 제품 태그 (Supplier Product Tag) - For search/matching
model SupplierProductTag {
  id        String   @id @default(uuid())
  name      String   @unique
  created_at DateTime @default(now())
  
  @@index([name])
}
