datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client-supplier"
}

// 공급업체 (Supplier) - Supplier company information
model Supplier {
  id                 String    @id @default(uuid())
  tenant_id          String?   @unique // Unique - used as foreign key by SupplierManager
  company_name       String
  business_number    String    @unique // 사업자 등록번호
  company_phone      String?
  company_email      String
  company_address    String?
  product_categories String[]  @default([]) // 취급 제품 카테고리
  share_consent      Boolean   @default(false) // 회사 정보 공유 동의
  status             String    @default("pending") // pending, approved, rejected
  created_at         DateTime  @default(now())
  updated_at         DateTime?

  // Relations
  clinicManagers ClinicSupplierManager[]
  managers       SupplierManager[]

  @@index([tenant_id])
  @@index([business_number])
  @@index([status])
}

// Clinic tomonidan yaratilgan Supplier Manager (Clinic context'da)
model ClinicSupplierManager {
  id                    String    @id @default(uuid())
  supplier_id           String
  tenant_id             String // Qaysi clinic yaratgan
  name                  String
  phone_number          String // NOT UNIQUE - faqat clinic context'da
  email1                String?
  email2                String?
  position              String? // 직함
  certificate_image_url String? // 사업자등록증 이미지 URL
  responsible_regions   String[]  @default([])
  responsible_products  String[]  @default([])
  memo                  String?
  created_at            DateTime  @default(now())
  updated_at            DateTime?

  // Relations
  supplier      Supplier         @relation(fields: [supplier_id], references: [id], onDelete: Cascade)
  linkedManager SupplierManager? // Supplier ro'yxatdan o'tganda link qilinadi

  @@index([supplier_id])
  @@index([tenant_id])
  @@index([phone_number])
  @@index([tenant_id, phone_number]) // Composite index for clinic-specific search
}

// Supplier tomonidan yaratilgan Manager (Global, login uchun)
model SupplierManager {
  id                    String  @id @default(uuid())
  supplier_tenant_id    String // Supplier'ning tenant_id'si (supplier_id o'rniga)
  clinic_manager_id     String? @unique // ClinicSupplierManager bilan link (agar clinic yaratgan bo'lsa) - UNIQUE for one-to-one
  manager_id            String  @unique // 담당자 ID (회사이름+4자리 숫자)
  name                  String
  phone_number          String  @unique // UNIQUE - global
  certificate_image_url String? // 사업자등록증 이미지 URL

  // 계정 정보 (required for login)
  password_hash String? // Optional - supplier ro'yxatdan o'tganda to'ldiriladi
  email1        String? // Optional - supplier ro'yxatdan o'tganda to'ldiriladi

  // 담당 정보
  manager_address      String? // 담당자 주소 (responsible_regions o'rniga)
  responsible_products String[] @default([]) // 담당 제품
  position             String? // 직함 (Job Title): 사원, 주임, 대리, 과장, 차장, 부장

  // 알림 설정 (Notification Settings)
  public_contact_name   Boolean @default(false) // 담당자 이름 공개
  allow_hospital_search Boolean @default(false) // 병의원 검색 허용
  receive_kakaotalk     Boolean @default(false) // 카톡 알림 받기
  receive_sms           Boolean @default(false) // 문자(SMS) 알림 받기
  receive_email         Boolean @default(false) // 이메일 알림 받기

  status           String    @default("pending") // pending, approved, rejected, active, deleted
  withdrawal_reason String? // 회원탈퇴 사유 (optional)
  created_at       DateTime  @default(now())
  updated_at       DateTime?
  created_by       String? // Who created this manager (clinic or self-registered)

  // Relations
  supplier      Supplier               @relation(fields: [supplier_tenant_id], references: [tenant_id], onDelete: Cascade)
  clinicManager ClinicSupplierManager? @relation(fields: [clinic_manager_id], references: [id], onDelete: SetNull)

  @@index([supplier_tenant_id])
  @@index([manager_id])
  @@index([phone_number])
  @@index([email1])
  @@index([status])
  @@index([clinic_manager_id])
  @@index([created_by])
}

// 공급업체 지역 태그 (Supplier Region Tag) - For search/matching
model SupplierRegionTag {
  id         String   @id @default(uuid())
  name       String   @unique
  created_at DateTime @default(now())

  @@index([name])
}

// 공급업체 제품 태그 (Supplier Product Tag) - For search/matching
model SupplierProductTag {
  id         String   @id @default(uuid())
  name       String   @unique
  created_at DateTime @default(now())

  @@index([name])
}

// Clinic → Supplier order header
model SupplierOrder {
  id                  String    @id @default(uuid())
  supplier_tenant_id  String // Which supplier company
  supplier_manager_id String? // Target manager (if any)
  clinic_tenant_id    String? // Which clinic sent the order
  clinic_name         String? // Denormalized clinic name
  clinic_manager_name String? // Denormalized clinic manager name
  order_no            String    @unique
  status              String    @default("pending") // pending, confirmed, rejected, shipped, completed
  total_amount        Int       @default(0)
  memo                String?
  order_date          DateTime  @default(now())
  created_at          DateTime  @default(now())
  updated_at          DateTime?

  items SupplierOrderItem[]

  @@index([supplier_tenant_id])
  @@index([supplier_manager_id])
  @@index([clinic_tenant_id])
  @@index([status])
  @@index([order_date])
}

// Clinic → Supplier order items
model SupplierOrderItem {
  id           String  @id @default(uuid())
  order_id     String
  product_id   String?
  product_name String
  brand        String?
  batch_no     String?
  quantity     Int
  unit_price   Int
  total_price  Int
  memo         String?

  // Timestamps
  created_at DateTime  @default(now())
  updated_at DateTime?

  order SupplierOrder @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([order_id])
  @@index([product_id])
}

// Clinic → Supplier return request
model SupplierReturnRequest {
  id                String   @id @default(uuid())
  supplier_tenant_id String // Which supplier company
  supplier_manager_id String? // Target manager (if any)
  clinic_tenant_id    String // Which clinic sent the return
  clinic_name         String // Denormalized clinic name
  clinic_manager_name String // Denormalized clinic manager name (담당자)
  return_no           String  @unique // 반품번호: B + YYYYMMDD + 6 random digits
  status              String  @default("pending") // pending, processing, completed, rejected
  memo                String? // General memo for the return request
  created_at          DateTime @default(now())
  updated_at          DateTime?
  confirmed_at        DateTime? // When supplier confirms (요청 확인)
  completed_at        DateTime? // When supplier marks as received (제품 받았음)
  rejected_at         DateTime? // When supplier rejects
  rejected_reason     String? // Rejection reason

  items SupplierReturnItem[]

  @@index([supplier_tenant_id])
  @@index([supplier_manager_id])
  @@index([clinic_tenant_id])
  @@index([return_no])
  @@index([status])
  @@index([created_at])
}

// Clinic → Supplier return request items
model SupplierReturnItem {
  id              String   @id @default(uuid())
  return_request_id String
  product_name    String
  brand           String?
  quantity        Int
  status          String   @default("pending") // pending, processing, completed, rejected
  return_type     String // "주문|반품", "주문|교환", "불량|반품", "불량|교환"
  memo            String? // Item-specific memo
  images          String[] @default([]) // Image URLs
  inbound_date    String   // YYYY-MM-DD format
  total_price     Int
  order_no        String?  // For 주문 returns
  batch_no        String?  // For 불량 returns

  created_at DateTime @default(now())
  updated_at DateTime?

  returnRequest SupplierReturnRequest @relation(fields: [return_request_id], references: [id], onDelete: Cascade)

  @@index([return_request_id])
}
