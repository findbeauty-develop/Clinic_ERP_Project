generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client-backend"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Product {
  id                   String    @id @default(uuid())
  tenant_id            String
  name                 String
  barcode              String?
  created_at           DateTime  @default(now())
  updated_at           DateTime?
  brand                String
  category             String
  current_stock        Int       @default(0)
  image_url            String?
  is_active            Boolean   @default(true)
  min_stock            Int       @default(0)
  status               String    @default("활성")
  unit                 String?
  purchase_price       Int?
  sale_price           Int?
  capacity_per_product Int?
  capacity_unit        String?
  usage_capacity       Int?

  // Product-level expiry defaults (yangi fieldlar)
  expiry_months Int? // 유통기한 기간 (default for all batches)
  expiry_unit   String? // 유통기한 단위 ("months" or "days")
  alert_days    String? // 알림 일수 (유효기간 임박 alert)

  // Packaging unit conversion
  has_different_packaging_quantity Boolean @default(false) // 포장 단위 내 제품 수량이 다른 경우
  packaging_from_quantity          Int? // 포장 단위 수량 (예: 1)
  packaging_from_unit              String? // 포장 단위 (예: "box")
  packaging_to_quantity            Int? // 제품 수량 (예: 2)
  packaging_to_unit                String? // 제품 단위 (예: "ea")

  batches          Batch[]
  orderItems       OrderItem[]
  outbounds        Outbound[]
  packageItems     PackageItem[]
  returns          Return[]
  returnPolicy     ReturnPolicy?
  supplierProducts SupplierProduct[]

  @@index([tenant_id])
}

model Clinic {
  id                    String    @id @default(uuid())
  tenant_id             String
  name                  String
  english_name          String
  category              String
  location              String
  phone_number          String?
  medical_subjects      String
  license_type          String
  license_number        String
  document_issue_number String
  document_image_urls   String[]  @default([])
  created_at            DateTime  @default(now())
  created_by            String?
  updated_at            DateTime?
  updated_by            String?
  doctor_name           String?
  open_date             DateTime?
  // Privacy and disclosure settings
  allow_company_search  Boolean   @default(false) // 기업 검색 허용
  allow_info_disclosure Boolean   @default(false) // 병의원 정보 공개

  @@index([tenant_id])
}

model Member {
  id                   String    @id @default(uuid())
  tenant_id            String
  member_id            String    @unique
  role                 String
  password_hash        String
  clinic_name          String
  created_at           DateTime  @default(now())
  created_by           String?
  updated_at           DateTime?
  updated_by           String?
  full_name            String?
  phone_number         String?
  id_card_number       String?
  address              String?
  must_change_password Boolean   @default(false)

  @@index([tenant_id])
}

model ReturnPolicy {
  id             String    @id @default(uuid())
  tenant_id      String
  product_id     String    @unique
  is_returnable  Boolean   @default(false)
  refund_amount  Float     @default(0)
  return_storage String?
  note           String?
  created_at     DateTime  @default(now())
  updated_at     DateTime?
  product        Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
}

model Batch {
  id               String      @id @default(uuid())
  tenant_id        String
  product_id       String
  batch_no         String
  storage          String?
  purchase_price   Int?
  sale_price       Int?
  manufacture_date DateTime?
  expiry_date      DateTime?
  expiry_months    Int?
  qty              Int
  alert_days       String?
  used_count       Int         @default(0) // Ishlatilgan mahsulotlar soni (usageCapacity asosida)
  created_at       DateTime    @default(now())
  updated_at       DateTime?
  expiry_unit      String?
  inbound_manager  String?
  product          Product     @relation(fields: [product_id], references: [id], onDelete: Cascade)
  orderItems       OrderItem[]
  outbounds        Outbound[]
  returns          Return[]

  @@index([tenant_id])
  @@index([product_id])
  @@index([tenant_id, product_id])
}

model SupplierProduct {
  id                 String    @id @default(uuid())
  tenant_id          String
  product_id         String
  supplier_id        String?
  purchase_price     Int?
  moq                Int?
  lead_time_days     Int?
  note               String?
  created_at         DateTime  @default(now())
  updated_at         DateTime?
  contact_name       String?
  contact_phone      String?
  contact_email      String?
  supplier_tenant_id String?
  company_name       String?
  product            Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([product_id])
  @@index([supplier_id])
  @@index([supplier_tenant_id])
  @@index([tenant_id, product_id])
}

model Outbound {
  id            String    @id @default(uuid())
  tenant_id     String
  product_id    String
  batch_id      String
  batch_no      String
  outbound_qty  Int
  outbound_date DateTime  @default(now())
  manager_name  String
  patient_name  String?
  chart_number  String?
  memo          String?
  created_at    DateTime  @default(now())
  updated_at    DateTime?
  created_by    String?
  is_damaged    Boolean   @default(false)
  is_defective  Boolean   @default(false)
  outbound_type String    @default("제품")
  package_id    String?
  batch         Batch     @relation(fields: [batch_id], references: [id], onDelete: Cascade)
  product       Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  returns       Return[]

  @@index([tenant_id])
  @@index([product_id])
  @@index([batch_id])
  @@index([outbound_date])
  @@index([outbound_type])
  @@index([tenant_id, outbound_date])
}

model Package {
  id          String        @id @default(uuid())
  tenant_id   String
  name        String
  description String?
  is_active   Boolean       @default(true)
  created_at  DateTime      @default(now())
  updated_at  DateTime?
  created_by  String?
  updated_by  String?
  items       PackageItem[]

  @@index([tenant_id])
  @@index([tenant_id, is_active])
}

model PackageItem {
  id         String  @id @default(uuid())
  tenant_id  String
  package_id String
  product_id String
  quantity   Int     @default(1)
  order      Int     @default(0)
  package    Package @relation(fields: [package_id], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([package_id, product_id])
  @@index([tenant_id])
  @@index([package_id])
  @@index([product_id])
}

model PackageReservation {
  id           String    @id @default(uuid())
  tenant_id    String
  package_id   String
  product_id   String
  batch_id     String
  reserved_qty Int
  created_at   DateTime  @default(now())
  updated_at   DateTime?

  @@index([tenant_id])
  @@index([package_id])
  @@index([product_id])
  @@index([batch_id])
  @@index([tenant_id, package_id])
  @@index([tenant_id, product_id])
  @@index([tenant_id, batch_id])
}

model Return {
  id            String    @id @default(uuid())
  tenant_id     String
  product_id    String
  batch_id      String
  outbound_id   String?
  batch_no      String
  supplier_id   String?
  return_no     String? // 반품번호: R + YYYYMMDD + 6 random digits (for supplier communication)
  return_qty    Int
  return_date   DateTime  @default(now())
  refund_amount Float     @default(0)
  total_refund  Float     @default(0)
  manager_name  String
  memo          String?
  created_at    DateTime  @default(now())
  updated_at    DateTime?
  created_by    String?
  batch         Batch     @relation(fields: [batch_id], references: [id], onDelete: Cascade)
  outbound      Outbound? @relation(fields: [outbound_id], references: [id])
  product       Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([product_id])
  @@index([batch_id])
  @@index([outbound_id])
  @@index([return_date])
  @@index([tenant_id, return_date])
}

model Order {
  id                     String    @id @default(uuid())
  tenant_id              String
  order_no               String    @unique
  status                 String    @default("draft") // draft, pending, supplier_confirmed, inbound_completed, cancelled
  supplier_id            String?
  total_amount           Float     @default(0)
  order_date             DateTime  @default(now())
  expected_delivery_date DateTime?
  created_by             String?
  approved_by            String?
  memo                   String?

  // Supplier confirmation data
  supplier_adjustments Json? // Supplier'ning adjustment ma'lumotlari (qty, price, reasons)
  confirmed_at         DateTime? // Supplier qachon confirm qilgan

  created_at DateTime    @default(now())
  updated_at DateTime?
  items      OrderItem[]

  @@index([tenant_id])
  @@index([supplier_id])
  @@index([status])
  @@index([order_date])
  @@index([tenant_id, status])
  @@index([tenant_id, order_date])
}

model OrderItem {
  id          String    @id @default(uuid())
  tenant_id   String
  order_id    String
  product_id  String
  batch_id    String?
  quantity    Int
  unit_price  Int
  total_price Int
  memo        String?
  created_at  DateTime  @default(now())
  updated_at  DateTime?
  batch       Batch?    @relation(fields: [batch_id], references: [id])
  order       Order     @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product     Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([order_id])
  @@index([product_id])
  @@index([batch_id])
  @@index([tenant_id, order_id])
}

model OrderDraft {
  id           String   @id @default(uuid())
  tenant_id    String
  session_id   String
  items        Json
  total_amount Float    @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @default(now())
  expires_at   DateTime

  @@unique([tenant_id, session_id])
  @@index([tenant_id])
  @@index([session_id])
  @@index([expires_at])
}

model OrderReturn {
  id              String    @id @default(uuid())
  tenant_id       String
  order_id        String? // Optional for defective products from outbound
  order_no        String? // Optional for defective products from outbound
  outbound_id     String? // For defective products from outbound
  return_no       String? // 반품번호: B + YYYYMMDD + 6 random digits
  batch_no        String
  product_id      String
  product_name    String
  brand           String?
  return_quantity Int // 미입고수량 (excess/defective qty)
  total_quantity  Int // confirmedQuantity from supplier (for order returns) or outbound qty (for defective)
  unit_price      Int
  return_type     String // "주문|반품", "주문|교환", "불량|반품", "불량|교환"
  status          String    @default("pending") // "pending", "processing", "completed", "rejected"
  memo            String?
  images          String[]  @default([])
  return_manager  String? // 반품 담당자
  supplier_id     String?
  inbound_date    DateTime  @default(now())
  created_at      DateTime  @default(now())
  updated_at      DateTime?

  @@index([tenant_id])
  @@index([order_id])
  @@index([outbound_id])
  @@index([return_no])
  @@index([status])
  @@index([tenant_id, status])
  @@index([return_type])
}

model RejectedOrder {
  id            String    @id @default(uuid())
  tenant_id     String
  order_id      String
  order_no      String
  company_name  String // Supplier company name
  manager_name  String // Supplier manager name
  product_name  String
  product_brand String?
  qty           Int // Rejected quantity
  member_name   String // Member who checked/confirmed the rejection
  created_at    DateTime  @default(now())
  updated_at    DateTime?

  @@index([tenant_id])
  @@index([order_id])
  @@index([order_no])
  @@index([tenant_id, order_id])
}

model Supplier {
  id                 String                  @id @default(uuid())
  tenant_id          String                  @unique
  company_name       String
  business_number    String                  @unique
  company_phone      String?
  company_email      String
  company_address    String?
  product_categories String[]                @default([])
  share_consent      Boolean                 @default(false)
  status             String                  @default("MANUAL_ONLY")
  created_at         DateTime                @default(now())
  updated_at         DateTime?
  clinicManagers     ClinicSupplierManager[]
  managers           SupplierManager[]       @relation("SupplierToManagers")

  @@index([tenant_id])
  @@index([business_number])
  @@index([status])
}

model ClinicSupplierLink {
  id                  String          @id @default(uuid())
  tenant_id           String
  status              String          @default("REQUESTED")
  requested_at        DateTime        @default(now())
  approved_at         DateTime?
  blocked_at          DateTime?
  created_at          DateTime        @default(now())
  updated_at          DateTime?
  supplier_manager_id String
  supplierManager     SupplierManager @relation(fields: [supplier_manager_id], references: [id], onDelete: Cascade)

  @@unique([tenant_id, supplier_manager_id])
  @@index([tenant_id])
  @@index([supplier_manager_id])
  @@index([status])
  @@index([tenant_id, status])
}

model ClinicSupplierManager {
  id                    String           @id @default(uuid())
  supplier_id           String
  tenant_id             String
  name                  String
  phone_number          String
  email1                String?
  email2                String?
  position              String?
  certificate_image_url String?
  responsible_regions   String[]         @default([])
  responsible_products  String[]         @default([])
  memo                  String?
  created_at            DateTime         @default(now())
  updated_at            DateTime?
  supplier              Supplier         @relation(fields: [supplier_id], references: [id], onDelete: Cascade)
  linkedManager         SupplierManager?

  @@index([supplier_id])
  @@index([tenant_id])
  @@index([phone_number])
  @@index([tenant_id, phone_number])
}

model SupplierManager {
  id                          String                       @id @default(uuid())
  manager_id                  String                       @unique
  name                        String
  phone_number                String                       @unique
  certificate_image_url       String?
  password_hash               String?
  email1                      String?
  responsible_products        String[]                     @default([])
  status                      String                       @default("ACTIVE")
  created_at                  DateTime                     @default(now())
  updated_at                  DateTime?
  position                    String?
  clinic_manager_id           String?                      @unique
  supplier_tenant_id          String
  manager_address             String?
  created_by                  String?
  clinicLinks                 ClinicSupplierLink[]
  clinicManager               ClinicSupplierManager?       @relation(fields: [clinic_manager_id], references: [id])
  supplierReturnNotifications SupplierReturnNotification[]

  supplier Supplier @relation("SupplierToManagers", fields: [supplier_tenant_id], references: [tenant_id])

  @@index([supplier_tenant_id])
  @@index([manager_id])
  @@index([phone_number])
  @@index([email1])
  @@index([status])
  @@index([clinic_manager_id])
  @@index([created_by])
}

model SupplierReturnNotification {
  id                     String          @id @default(uuid())
  supplier_manager_id    String
  return_id              String
  clinic_tenant_id       String
  clinic_name            String?
  product_id             String
  product_name           String
  product_brand          String
  product_code           String?
  return_qty             Int
  refund_amount_per_item Float
  total_refund           Float
  return_manager_name    String
  return_date            DateTime
  batch_no               String?
  status                 String          @default("PENDING")
  is_read                Boolean         @default(false)
  created_at             DateTime        @default(now())
  updated_at             DateTime?
  accepted_at            DateTime?
  rejected_at            DateTime?
  supplierManager        SupplierManager @relation(fields: [supplier_manager_id], references: [id], onDelete: Cascade)

  @@index([supplier_manager_id])
  @@index([return_id])
  @@index([clinic_tenant_id])
  @@index([status])
  @@index([is_read])
  @@index([supplier_manager_id, status])
  @@index([supplier_manager_id, is_read])
  @@index([created_at])
}

model SupplierOrder {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  supplier_tenant_id  String
  supplier_manager_id String?
  clinic_tenant_id    String?
  clinic_name         String?
  clinic_manager_name String?
  order_no            String              @unique
  status              String              @default("pending")
  total_amount        Int                 @default(0)
  memo                String?
  order_date          DateTime            @default(now()) @db.Timestamptz(6)
  created_at          DateTime            @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?           @db.Timestamptz(6)
  SupplierOrderItem   SupplierOrderItem[]

  @@index([clinic_tenant_id], map: "SupplierOrder_clinic_tenant_idx")
  @@index([order_date])
  @@index([status])
  @@index([supplier_manager_id], map: "SupplierOrder_supplier_manager_idx")
  @@index([supplier_tenant_id], map: "SupplierOrder_supplier_tenant_idx")
}

model SupplierOrderItem {
  id            String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id      String        @db.Uuid
  product_id    String?
  product_name  String
  brand         String?
  batch_no      String?
  quantity      Int
  unit_price    Int
  total_price   Int
  memo          String?
  created_at    DateTime      @default(now()) @db.Timestamptz(6)
  updated_at    DateTime?     @db.Timestamptz(6)
  SupplierOrder SupplierOrder @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([order_id])
  @@index([product_id])
}

model WarehouseLocation {
  id         String    @id @default(uuid())
  tenant_id  String
  name       String
  category   String? // 수면실, 레이저 실, 창고, 기타
  items      String[]  @default([]) // A 침대, B 침대, etc.
  created_at DateTime  @default(now())
  updated_at DateTime?

  @@unique([tenant_id, name])
  @@index([tenant_id])
  @@index([category])
}

model NewsCache {
  id         String   @id @default(uuid())
  cache_key  String   @unique
  data       String   // JSON string
  updated_at DateTime @default(now())
  created_at DateTime @default(now())

  @@index([cache_key])
  @@index([updated_at])
}