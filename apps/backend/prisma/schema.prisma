datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Product {
  id                   String    @id @default(uuid())
  tenant_id            String
  name                 String
  brand                String
  barcode              String?
  image_url            String?
  category             String
  status               String    @default("활성")
  is_active            Boolean   @default(true)
  unit                 String?
  purchase_price       Int?
  sale_price           Int?
  current_stock        Int       @default(0)
  min_stock            Int       @default(0)
  capacity_per_product Int? // 제품당 용량
  capacity_unit        String? // 용량 단위
  usage_capacity       Int? // 사용 용량
  created_at           DateTime  @default(now())
  updated_at           DateTime?

  returnPolicy     ReturnPolicy?
  batches          Batch[]
  supplierProducts SupplierProduct[]
  outbounds        Outbound[]
  packageItems     PackageItem[]
  returns          Return[]
  orderItems       OrderItem[]

  @@index([tenant_id])
}

model Clinic {
  id                    String    @id @default(uuid())
  tenant_id             String
  name                  String
  english_name          String
  category              String
  location              String
  medical_subjects      String
  description           String?
  license_type          String
  license_number        String
  document_issue_number String
  document_image_urls   String[]  @default([])
  
  // OCR'dan olingan field'lar (Optional)
  open_date             DateTime? // 개설신고일자 (Open date from OCR)
  doctor_name           String?   // 성명 (Doctor name from OCR)
  
  created_at            DateTime  @default(now())
  created_by            String?
  updated_at            DateTime?
  updated_by            String?

  @@index([tenant_id])
}

model Member {
  id             String    @id @default(uuid())
  tenant_id      String
  member_id      String    @unique
  role           String
  password_hash  String
  clinic_name    String
  full_name      String?
  phone_number   String?
  id_card_number String?
  address        String?
  created_at     DateTime  @default(now())
  created_by     String?
  updated_at     DateTime?
  updated_by     String?

  @@index([tenant_id])
}

model ReturnPolicy {
  id             String    @id @default(uuid())
  tenant_id      String
  product_id     String    @unique
  is_returnable  Boolean   @default(false)
  refund_amount  Float     @default(0)
  return_storage String?
  note           String?
  created_at     DateTime  @default(now())
  updated_at     DateTime?

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
}

model Batch {
  id               String    @id @default(uuid())
  tenant_id        String
  product_id       String
  batch_no         String
  storage          String?
  purchase_price   Int?
  sale_price       Int?
  manufacture_date DateTime?
  expiry_date      DateTime?
  expiry_months    Int?
  expiry_unit      String?
  qty              Int
  alert_days       String?
  inbound_manager  String? // 입고 담당자 (Inbound manager/responsible person)
  created_at       DateTime  @default(now())
  updated_at       DateTime?

  product   Product    @relation(fields: [product_id], references: [id], onDelete: Cascade)
  outbounds Outbound[]
  returns   Return[]
  orderItems OrderItem[]

  @@index([tenant_id])
  @@index([product_id])
  @@index([tenant_id, product_id])
}

model SupplierProduct {
  id             String    @id @default(uuid())
  tenant_id      String
  product_id     String
  supplier_id    String
  purchase_price Int?
  moq            Int?
  lead_time_days Int?
  note           String?
  contact_name   String?
  contact_phone  String?
  contact_email  String?
  created_at     DateTime  @default(now())
  updated_at     DateTime?

  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@index([tenant_id])
  @@index([product_id])
  @@index([supplier_id])
  @@index([tenant_id, product_id])
}

model Outbound {
  id         String @id @default(uuid())
  tenant_id  String
  product_id String
  batch_id   String // Qaysi batch'dan chiqarilgani
  batch_no   String // Batch raqami (reference uchun)

  // 출고 정보
  outbound_qty  Int // 출고 수량 (Outbound quantity)
  outbound_date DateTime @default(now()) // 출고 날짜
  outbound_type String   @default("제품") // 출고 타입: 제품, 패키지, 바코드

  // 담당자 정보
  manager_name String // 담당자 (Responsible person)

  // 환자 정보 (선택)
  patient_name String? // 환자 이름 (Patient name - optional)
  chart_number String? // 차트번호 (Chart number - optional)

  // 상태 정보
  is_damaged   Boolean @default(false) // 파손 (Damaged)
  is_defective Boolean @default(false) // 불량 (Defective)

  // 기타
  memo       String? // 메모 (Memo - optional)
  package_id String? // 패키지 ID (패키지 출고인 경우)

  // Timestamps
  created_at DateTime  @default(now())
  updated_at DateTime?
  created_by String? // 출고한 사용자

  // Relations
  product Product  @relation(fields: [product_id], references: [id], onDelete: Cascade)
  batch   Batch    @relation(fields: [batch_id], references: [id], onDelete: Cascade)
  returns Return[] // 반납 기록

  @@index([tenant_id])
  @@index([product_id])
  @@index([batch_id])
  @@index([outbound_date])
  @@index([outbound_type])
  @@index([tenant_id, outbound_date])
}

model Package {
  id          String    @id @default(uuid())
  tenant_id   String
  name        String
  description String?
  is_active   Boolean   @default(true)
  created_at  DateTime  @default(now())
  updated_at  DateTime?
  created_by  String?
  updated_by  String?

  items PackageItem[]

  @@index([tenant_id])
  @@index([tenant_id, is_active])
}

// Paket
model PackageItem {
  id         String @id @default(uuid())
  tenant_id  String
  package_id String
  product_id String
  quantity   Int    @default(1)
  order      Int    @default(0)

  package Package @relation(fields: [package_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([package_id, product_id])
  @@index([tenant_id])
  @@index([package_id])
  @@index([product_id])
}

// 반납 (Return)
model Return {
  id          String  @id @default(uuid())
  tenant_id   String
  product_id  String
  batch_id    String // Qaysi batch'dan qaytarilgani
  outbound_id String? // Qaysi outbound'dan qaytarilgani (reference)
  batch_no    String // Batch raqami (reference uchun)
  supplier_id String? // 공급업체 ID (SupplierProduct'dan olinadi)

  // 반납 정보
  return_qty    Int // 반납 수량 (Return quantity)
  return_date   DateTime @default(now()) // 반납 날짜
  refund_amount Float    @default(0) // 개당 할인 금액 (ReturnPolicy'dan olinadi)
  total_refund  Float    @default(0) // 총 반납 금액 (return_qty * refund_amount)

  // 담당자 정보
  manager_name String // 반납 담당자 (Return manager)

  // 기타
  memo String? // 메모 (Memo - optional)

  // Timestamps
  created_at DateTime  @default(now())
  updated_at DateTime?
  created_by String? // 반납한 사용자

  // Relations
  product  Product   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  batch    Batch     @relation(fields: [batch_id], references: [id], onDelete: Cascade)
  outbound Outbound? @relation(fields: [outbound_id], references: [id], onDelete: SetNull)

  @@index([tenant_id])
  @@index([product_id])
  @@index([batch_id])
  @@index([outbound_id])
  @@index([return_date])
  @@index([tenant_id, return_date])
}

// 주문 (Order) - Buyurtma
model Order {
  id          String    @id @default(uuid())
  tenant_id   String
  order_no    String    @unique // 주문서 번호 (Order number)
  status      String    @default("draft") // draft, pending, confirmed, completed, cancelled
  supplier_id String?   // 공급업체 ID (Supplier ID)
  
  // 주문 정보
  total_amount Float    @default(0) // 총 주문 금액
  order_date   DateTime @default(now()) // 주문 날짜
  expected_delivery_date DateTime? // 예상 배송일
  
  // 담당자 정보
  created_by   String?  // 주문 생성자
  approved_by  String?  // 승인자
  
  // 기타
  memo         String?  // 메모
  
  // Timestamps
  created_at   DateTime @default(now())
  updated_at   DateTime?
  
  // Relations
  items        OrderItem[]
  
  @@index([tenant_id])
  @@index([supplier_id])
  @@index([status])
  @@index([order_date])
  @@index([tenant_id, status])
  @@index([tenant_id, order_date])
}

// 주문 항목 (Order Item)
model OrderItem {
  id          String  @id @default(uuid())
  tenant_id   String
  order_id    String
  product_id  String
  batch_id    String? // Batch ID (agar batch bo'yicha buyurtma bo'lsa)
  
  // 주문 정보
  quantity    Int     // 주문 수량
  unit_price  Int     // 개당 가격 (purchase price)
  total_price Int     // 총 가격 (quantity * unit_price)
  
  // 기타
  memo        String? // 메모
  
  // Timestamps
  created_at  DateTime @default(now())
  updated_at  DateTime?
  
  // Relations
  order   Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [id], onDelete: Cascade)
  batch   Batch?  @relation(fields: [batch_id], references: [id], onDelete: SetNull)
  
  @@index([tenant_id])
  @@index([order_id])
  @@index([product_id])
  @@index([batch_id])
  @@index([tenant_id, order_id])
}

// 주문 초안 (Order Draft) - Session-based temporary order
model OrderDraft {
  id          String  @id @default(uuid())
  tenant_id   String
  session_id  String  // Frontend session ID yoki user ID
  
  // 초안 정보
  items       Json    // OrderItem[] formatida JSON
  total_amount Float  @default(0)
  
  // Timestamps
  created_at  DateTime @default(now())
  updated_at  DateTime @default(now())
  expires_at  DateTime // Session expiration time
  
  @@unique([tenant_id, session_id])
  @@index([tenant_id])
  @@index([session_id])
  @@index([expires_at])
}
